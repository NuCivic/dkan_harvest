machine:
  timezone:
    America/New_York
  php:
    version: '5.5.11'
  environment:
    DATABASE_URL: mysql://ubuntu:@127.0.0.1:3306/circle_test
    COMPOSER_PATH: $HOME/.config/composer/vendor/bin
    PATH: $COMPOSER_PATH:$PATH
checkout:
  post:
    # Remove the extra composer stuff that circleci loads and that is causing conflicts with drush.
    - rm -rf ~/.composer

dependencies:
  pre:
    - echo "memory_limit = 256M" > ~/.phpenv/versions/5.5.11/etc/conf.d/memory.ini
  cache_directories:
     #- "test/vendor"
     #- "~/.composer"
     #- "~/.drush"
     #- "~/backups"
     #- "test/sites/default"
  override:
    - mkdir $CIRCLE_ARTIFACTS/junit
    - 'bash dkan-module-init.sh --deps --build=$DATABASE_URL'
    - cd dkan_harvest && composer install && cd ..
    - ahoy drush -y en dkan_harvest_test
    # Remove all dkan tests for now
    - rm -rf dkan/test/features/*.feature
    - cp dkan_harvest/test/behat/features/*.feature dkan/test/features/
    - 'ahoy drush --yes runserver :8888':
        background: true
    - wget http://selenium-release.storage.googleapis.com/2.48/selenium-server-standalone-2.48.2.jar
    - java -jar selenium-server-standalone-2.48.2.jar -quiet -p 4444 -log shut_up_selenium :
        background: true
test:
  override:
    - dkan_harvest/bin/phpunit --configuration dkan_harvest/test/phpunit
    - bash dkan/test/circle-behat.sh docroot/profiles/dkan/test/features